(()=>{"use strict";function e(e){e.classList.add("popup_is-opened")}function t(e){e.classList.remove("popup_is-opened")}function o(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&(t(e),document.removeEventListener("keydown",o))}}function n({name:t,link:o,_id:n,owner:c,likes:p}){const i=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0);i.setAttribute("data-id",n);const d=i.querySelector(".card__image"),l=i.querySelector(".card__title"),s=i.querySelector(".card__delete-button"),_=i.querySelector(".card__like-button"),y=i.querySelector(".card__like-count");return d.src=o,d.alt=t,l.textContent=t,y.textContent=p.length,a().then((e=>{e._id!==c._id?s.style.display="none":s.addEventListener("click",(()=>{var e;u(`/cards/${e=n}`,{method:"DELETE"}).then((()=>{const t=document.querySelector(`[data-id="${e}"]`);t&&t.remove()})).catch((e=>{console.error("Ошибка при удалении карточки:",e),alert("Не удалось удалить карточку. Пожалуйста, попробуйте ещё раз.")}))})),p.some((t=>t._id===e._id))&&_.classList.add("card__like-button_is-active"),_.addEventListener("click",(()=>{const e=i.getAttribute("data-id");_.classList.contains("card__like-button_is-active")?function(e){u(`/cards/likes/${e}`,{method:"DELETE"}).then((e=>{r(e)}))}(e):function(e){u(`/cards/likes/${e}`,{method:"PUT"}).then((e=>{r(e)}))}(e)}))})),d.addEventListener("click",(()=>function(t,o){const n=imagePopup.querySelector(".popup__image"),r=imagePopup.querySelector(".popup__caption");n.src=t,n.alt=o,r.textContent=o,e(imagePopup)}(o,t))),i}function r(e){const t=document.querySelector(`[data-id="${e._id}"]`),o=t.querySelector(".card__like-button");t.querySelector(".card__like-count").textContent=e.likes.length,a().then((t=>{e.likes.some((e=>e._id===t._id))?o.classList.add("card__like-button_is-active"):o.classList.remove("card__like-button_is-active")}))}const c={baseUrl:"https://nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"e7ed7294-3c81-43c8-872d-a5a1eadbb865","Content-Type":"application/json"}};function u(e,t){return fetch(`${c.baseUrl}${e}`,{...t,headers:c.headers}).then((e=>e.ok?e.json():e.json().then((t=>Promise.reject(`Ошибка: ${e.status} - ${t.message}`)))))}function a(){return u("/users/me",{method:"GET"})}const p=document.querySelector(".popup_type_edit");function i(e){e.preventDefault();const o={name:l.value,about:s.value};u("/users/me",{method:"PATCH",body:JSON.stringify(o)}).then((e=>{_.textContent=e.name,y.textContent=e.about,t(p)})).catch((e=>alert("Не удалось обновить профиль.")))}const d=p.querySelector(".popup__form"),l=d.querySelector(".popup__input_type_name"),s=d.querySelector(".popup__input_type_description"),_=document.querySelector(".profile__title"),y=document.querySelector(".profile__description");d.addEventListener("submit",i);const m=document.querySelector(".popup_type_new-card"),v=m.querySelector(".popup__form"),S=v.querySelector(".popup__input_type_card-name"),q=v.querySelector(".popup__input_type_url"),b=v.querySelector(".popup__button"),f=document.querySelector(".popup_type_edit").querySelector(".popup__form");function h(e){e.preventDefault();const o={name:S.value,link:q.value};u("/cards",{method:"POST",body:JSON.stringify(o)}).then((e=>{const o=n(e);placesList.prepend(o),t(m),v.reset()})).catch((e=>{console.error("Ошибка при добавлении карточки:",e),alert("Не удалось добавить карточку. Пожалуйста, попробуйте ещё раз.")}))}function L(){f.checkValidity()?(f.querySelector(".popup__button").classList.remove("popup__button_disabled"),f.querySelector(".popup__button").disabled=!1):(f.querySelector(".popup__button").classList.add("popup__button_disabled"),f.querySelector(".popup__button").disabled=!0)}function E(){v.checkValidity()?(b.classList.remove("popup__button_disabled"),b.disabled=!1):(b.classList.add("popup__button_disabled"),b.disabled=!0)}v.addEventListener("submit",h),document.querySelector(".places__list");const k=document.querySelector(".popup_type_edit"),g=document.querySelector(".popup_type_new-card"),C=(document.querySelector(".popup_type_image"),document.querySelector(".profile__edit-button")),x=document.querySelector(".profile__add-button"),T=document.querySelectorAll(".popup__close"),$=k.querySelector(".popup__form"),P=$.querySelector(".popup__input_type_name"),A=$.querySelector(".popup__input_type_description"),w=document.querySelector(".profile__title"),D=document.querySelector(".profile__description");C.addEventListener("click",(()=>{P.value=w.textContent,A.value=D.textContent,e(k)})),$.addEventListener("submit",i),P.addEventListener("input",L),A.addEventListener("input",L);const j=g.querySelector(".popup__form"),N=j.querySelector(".popup__input_type_card-name"),O=j.querySelector(".popup__input_type_url");j.querySelector(".popup__button"),N.addEventListener("input",(()=>{M(N),E()})),O.addEventListener("input",(()=>{M(O),E()})),x.addEventListener("click",(()=>{j.reset(),E(),e(g)})),j.addEventListener("submit",h),T.forEach((e=>{e.addEventListener("click",(e=>{t(e.target.closest(".popup"))}))})),document.querySelectorAll(".popup").forEach((e=>{e.addEventListener("click",(o=>{o.target===e&&t(e)}))})),document.querySelectorAll(".popup__close").forEach((e=>{e.addEventListener("click",(()=>{t(e.closest(".popup")),document.removeEventListener("keydown",o)}))})),document.querySelector(".profile__edit-button").addEventListener("click",(()=>{document.querySelector(".popup_type_edit").classList.add("popup_is-opened"),document.addEventListener("keydown",o)})),u("/cards",{method:"GET"}).then((e=>{!function(e){const t=document.querySelector(".places__list");t.innerHTML="",e.forEach((e=>{const o=n(e);t.append(o)}))}(e)})),a().then((e=>{w.textContent=e.name,D.textContent=e.about})).catch((e=>{console.error("Ошибка при загрузке данных пользователя:",e),alert("Не удалось загрузить данные пользователя. Пожалуйста, попробуйте позже.")}));const H=document.querySelector(".profile__edit-avatar-button"),J=document.querySelector(".popup_type_edit-avatar"),I=J.querySelector(".popup__input_type_avatar"),U=J.querySelector(".popup__form"),V=J.querySelector(".popup__button"),G=document.querySelector(".profile__image");function M(e){const t=document.querySelector(`[data-error-for="${e.name}"]`);t?e.validity.valid?t.textContent="":t.textContent=e.validationMessage:console.error(`Элемент для отображения ошибки не найден: ${e.name}`)}H.addEventListener("click",(()=>{const t=G.style.backgroundImage;if(t&&"none"!==t){const e=/url\(["']?(.*?)["']?\)/,o=t.match(e);I.value=o?o[1]:""}else I.value="";e(J)})),I.addEventListener("input",(function(){U.checkValidity()?(V.classList.remove("popup__button_disabled"),V.disabled=!1):(V.classList.add("popup__button_disabled"),V.disabled=!0)})),U.addEventListener("submit",(e=>{e.preventDefault();const o={avatar:I.value};u("/users/me/avatar",{method:"PATCH",body:JSON.stringify(o)}).then((e=>{G.style.backgroundImage=`url(${e.avatar})`,t(J)})).catch((e=>{console.error("Ошибка при обновлении аватара:",e),alert("Не удалось обновить аватар. Пожалуйста, попробуйте позже.")}))})),U.addEventListener("submit",(function(e){if(e.preventDefault(),!I)return void console.error("Элемент avatarInput не найден");if(!I.value)return void alert("Пожалуйста, введите ссылку на аватар.");const o={avatar:I.value};u("/users/me/avatar",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then((e=>{console.log("Аватар успешно обновлен:",e),document.querySelector(".profile__image").src=e.avatar,t(J)})).catch((e=>{console.error("Ошибка при обновлении аватара:",e),alert("Не удалось обновить аватар. Попробуйте позже.")}))}))})();